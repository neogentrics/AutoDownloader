# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# This workflow will build, test, sign and package a WPF or Windows Forms desktop application
# built on .NET Core.

name: .NET Core Desktop Build and Publish

on:
  push:
    # Trigger on any push to 'master' (for testing builds)
    branches: [ "master" ]
  workflow_dispatch:
    # Allows manual running from the Actions tab on GitHub
  release:
    # Change trigger from 'published' to 'created'
    types: [created, edited, prereleased, released, published, unpublished]

jobs:

  build:
    # ADD THIS PERMISSIONS BLOCK
    permissions:
      contents: write # This grants permission to upload the asset to the release

    # We will only run on Release configuration for the publish step
    runs-on: windows-latest 

    env:
      # --- START CUSTOM CONFIGURATION ---
      Solution_Name: AutoDownloader.sln                           # Your solution file name.
      # We target .NET 9.0 (windows-latest has this or a compatible SDK)
      DotNet_Version: 9.0.x
      # We don't have a dedicated test project yet:
      Test_Project_Path: '' 
      # We are NOT using WAP (Windows App Packaging) for this build:
      Wap_Project_Path: ''
      Wap_Project_Directory: ''
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Install the .NET Core workload
    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        # Use the variable defined above
        dotnet-version: ${{ env.DotNet_Version }}

    # Add MSBuild to the PATH
    - name: Setup MSBuild.exe
      uses: microsoft/setup-msbuild@v2

    # CRITICAL STEP 1: RESTORE AND BUILD
    - name: Restore and Build Solution
      run: msbuild $env:Solution_Name /t:Restore /p:Configuration=Release /p:RestorePackagesConfig=true

# CRITICAL STEP 2: PUBLISH the executable (creating the self-contained files)
    # We target the specific UI project for the final executable.
    - name: Publish AutoDownloader.UI
      run: dotnet publish AutoDownloader.UI/AutoDownloader.UI.csproj -c Release -r win-x64 --self-contained true -o ${{ github.workspace }}/publish_output

    # CRITICAL STEP 3: ZIP the published executable for a clean release package
    - name: Zip Published Output
      run: |
        Compress-Archive -Path ${{ github.workspace }}/publish_output/* -DestinationPath ${{ github.workspace }}/AutoDownloader_${{ github.event.release.tag_name }}.zip

    # CRITICAL STEP 4: UPLOAD ARTIFACT (for testing/debugging builds)
    - name: Upload Build Artifact (for debugging)
      uses: actions/upload-artifact@v4
      with:
        name: AutoDownloader-${{ github.sha }}
        path: ${{ github.workspace }}/publish_output
    
    # CRITICAL STEP 5: ATTACH TO GITHUB RELEASE
    # This step only runs when the workflow is triggered by a new GitHub Release tag
    - name: Attach Asset to Release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ${{ github.workspace }}/AutoDownloader_${{ github.event.release.tag_name }}.zip
        asset_name: AutoDownloader_Installer_${{ github.event.release.tag_name }}.zip
        asset_content_type: application/zip

        # CRITICAL STEP 6: PUBLISH THE DRAFT RELEASE
    - name: Publish the Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        prerelease: false
        tag_name: ${{ github.event.release.tag_name }}
        # Note: Set the owner/repo path if needed, but the default context usually works.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
